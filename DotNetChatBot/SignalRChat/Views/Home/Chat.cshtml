@model SignalRChat.Models.ChatModel
@{
    ViewBag.Title = "Chat";


}




<!------ Include the above in your HEAD tag ---------->


@section scripts {
    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.0.3.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script>

            function onEnterDown(event) {
                if (event.which == 13 || event.keyCode == 13)
                    $("#sendmessage").click();
            }

            $(function () {
                // Reference the auto-generated proxy for the hub.
                var chat = $.connection.siemplifyChatHub;

                // Create a function that the hub can call back to display messages.
                chat.client.addNewMessageToPage = function (name, to, message, time) {
                    var contactName = "Guest";
                    if (to == "All" && contactName != 'All') {
                        //alert('not all - ' + contactName);
                        return;
                    }
                    var messagePosition = "";
                    if (name == "Guest") {
                        messagePosition = "end"
                    }
                    else
                    {
                        messagePosition = "start"
                    }

                    // Add the message to the page.
                        $('#discussion').append('<div class="d-flex justify-content-'+messagePosition+ 'mb-4"><div class="img_cont_msg"><img src="sergey.jpg" class="rounded-circle user_img_msg"></div> <div class="msg_cotainer">' + htmlEncode(message) + '<span class="msg_time">' + time + '</span></div></div>');
                };


                // callback from chat hub to add contact
                @*chat.client.addContact = function (name, department) {
                    if ($('#contacts').html().search(name) != -1) return;       // already added

                    var href = '@Url.Action("Chat", "Home")?name=' + escape($('#myname').text()) + '&contact=' + escape(name);
                    //"&department=" + htmlEncode(department);

                    $('#contacts').append('<a href=' + href + '><li><strong>' + htmlEncode(name)
                        + '</strong><span style="margin-left:50px;">' + htmlEncode(department) + '</span></li></a>');
                };

                chat.client.clearContacts = function () {
                    $('#contacts').empty();
                };*@


                // Get the user name and store it to prepend to messages.
                var myName = "Guest"; //prompt('Enter your name:', '');
                //if (myName == '')
                //    myName = 'Anonymous';

                $('#displayname').val(myName);

                var contactName = "Sergey";
                $('#activecontact').val(contactName);
                //$('#myname').text(myName);

                // Set initial focus to message input box.
                $('#message').focus();

                // Start the connection.
                $.connection.hub.start().done(function () {

                    //chat.server.connect($('#displayname').val(), $('#activecontact').val());

                    loadHistory();

                    // send message handler
                    $('#sendmessage').click(function () {
                        // Call the Send method on the hub.
                        chat.server.send($('#displayname').val(), $('#activecontact').val(), $('#message').val());

                        // Clear text box and reset focus for next comment.
                        $('#message').val('').focus();
                    });
                });
            });

            // This optional function html-encodes messages for display in the page.
            function htmlEncode(value) {
                var encodedValue = $('<div />').text(value).html();
                return encodedValue;
            }

            function loadHistory() {
                // load history
                $('#discussion').empty();

                //alert('@Model.History.Count.ToString()' + ' messages');
                var chat = $.connection.siemplifyChatHub;

                @foreach (var msg in Model.History) {
                    @:chat.client.addNewMessageToPage('@msg.FromUser', "Sergey", '@msg.Content', '@msg.Time');
                }

            }


    </script>
}
<!--Coded With Love By Mutiullah Samim-->

    <div class="container-fluid h-100">
        <div class="row justify-content-end h-100">
            <div class="col-md-8 col-xl-6 chat">
                <div class="card">
                    <div class="card-header msg_head">
                        <div class="d-flex bd-highlight">
                            <div class="img_cont">
                                <img src="sergey.jpg" class="rounded-circle user_img">
                                <span class="online_icon"></span>
                            </div>
                            <div class="user_info">
                                <span>Консультант Сергей</span>
                            </div>
                        </div>
                    </div>
                    <div class="caac" id="discussion">
                        @*<div class="d-flex justify-content-start mb-4">
                            <div class="img_cont_msg">
                                <img src="sergey.jpg" class="rounded-circle user_img_msg">
                            </div>
                            <div class="msg_cotainer">
                                Hi, how are you samim?
                                <span class="msg_time">8:40 AM, Today</span>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end mb-4">
                            <div class="msg_cotainer_send">
                                Hi Khalid i am good tnx how about you?
                                <span class="msg_time_send">8:55 AM, Today</span>
                            </div>

                        </div>f
                        <div class="d-flex justify-content-start mb-4">
                            <div class="img_cont_msg">
                                <img src="sergey.jpg" class="rounded-circle user_img_msg">
                            </div>
                            <div class="msg_cotainer">
                                I am good too, thank you for your chat template
                                <span class="msg_time">9:00 AM, Today</span>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end mb-4">
                            <div class="msg_cotainer_send">
                                You are welcome
                                <span class="msg_time_send">9:05 AM, Today</span>
                            </div>

                        </div>
                        <div class="d-flex justify-content-start mb-4">
                            <div class="img_cont_msg">
                                <img src="sergey.jpg" class="rounded-circle user_img_msg">
                            </div>
                            <div class="msg_cotainer">
                                I am looking for your next templates
                                <span class="msg_time">9:07 AM, Today</span>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end mb-4">
                            <div class="msg_cotainer_send">
                                Ok, thank you have a good day
                                <span class="msg_time_send">9:10 AM, Today</span>
                            </div>
                        </div>
                        <div class="d-flex justify-content-start mb-4">
                            <div class="img_cont_msg">
                                <img src="sergey.jpg" class="rounded-circle user_img_msg">
                            </div>
                            <div class="msg_cotainer">
                                Bye, see you
                                <span class="msg_time">9:12 AM, Today</span>
                            </div>
                        </div>*@
                    </div>
                    <div class="card-footer">
                        <div class="input-group">

                            <textarea name="" class="form-control type_msg" id="message" placeholder="Написать сообщение..." onkeypress="return onEnterDown(event)"></textarea>
                            <div class="input-group-append">
                                <span class="input-group-text send_btn" id="sendmessage"><i class="fas fa-location-arrow"></i></span>
                            </div>

                            <input type="hidden" id="displayname" />
                            <input type="hidden" id="activecontact" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


@*

    <h4 id="myname">Enter message</h4>
    <div class="row">
        <!-- contacts -->
        <div class="column left" style="background-color:#aaa;">
            <ul id="contacts"></ul>
        </div>
        <div class="container column right">
            <input type="text" id="message" onkeypress="return onEnterDown(event)" />
            <input type="button" id="sendmessage" value="Send" />

            <input type="hidden" id="displayname" />
            <input type="hidden" id="activecontact" />
            <ul id="discussion"><!--chat content goes here--></ul>
        </div>
    </div>
    @section scripts {
        <!--Script references. -->
        <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
        <!--Reference the SignalR library. -->
        <script src="~/Scripts/jquery.signalR-2.0.3.min.js"></script>
        <!--Reference the autogenerated SignalR hub script. -->
        <script src="~/signalr/hubs"></script>
        <!--SignalR script to update the chat page and send messages.-->
        <script>

            function onEnterDown(event) {
                if (event.which == 13 || event.keyCode == 13)
                    $("#sendmessage").click();
            }

            $(function () {
                // Reference the auto-generated proxy for the hub.
                var chat = $.connection.siemplifyChatHub;

                // Create a function that the hub can call back to display messages.
                chat.client.addNewMessageToPage = function (name, to, message, time) {
                    var contactName = "Sergey";
                    if (to == "All" && contactName != 'All') {
                        //alert('not all - ' + contactName);
                        return;
                    }


                    // Add the message to the page.
                    $('#discussion').append('<li>' + time + ': <b>' + htmlEncode(name)
                        + ' to ' + htmlEncode(to) + '</b>: ' + htmlEncode(message) + '</li>');
                };


                // callback from chat hub to add contact
                chat.client.addContact = function (name, department) {
                    if ($('#contacts').html().search(name) != -1) return;       // already added

                    var href = '@Url.Action("Chat", "Home")?name=' + escape($('#myname').text()) + '&contact=' + escape(name);
                    //"&department=" + htmlEncode(department);

                    $('#contacts').append('<a href=' + href + '><li><strong>' + htmlEncode(name)
                        + '</strong><span style="margin-left:50px;">' + htmlEncode(department) + '</span></li></a>');
                };

                chat.client.clearContacts = function () {
                    $('#contacts').empty();
                };


                // Get the user name and store it to prepend to messages.
                var myName = "Guest"; //prompt('Enter your name:', '');
                //if (myName == '')
                //    myName = 'Anonymous';

                $('#displayname').val(myName);

                var contactName = "Sergey";
                $('#activecontact').val(contactName);
                $('#myname').text(myName);

                // Set initial focus to message input box.
                $('#message').focus();

                // Start the connection.
                $.connection.hub.start().done(function () {

                    chat.server.connect($('#displayname').val(), $('#activecontact').val());

                    loadHistory();

                    // send message handler
                    $('#sendmessage').click(function () {
                        // Call the Send method on the hub.
                        chat.server.send($('#displayname').val(), $('#activecontact').val(), $('#message').val());

                        // Clear text box and reset focus for next comment.
                        $('#message').val('').focus();
                    });
                });
            });

            // This optional function html-encodes messages for display in the page.
            function htmlEncode(value) {
                var encodedValue = $('<div />').text(value).html();
                return encodedValue;
            }

            function loadHistory() {
                // load history
                $('#discussion').empty();

                //alert('@Model.History.Count.ToString()' + ' messages');
                var chat = $.connection.siemplifyChatHub;

                @foreach (var msg in Model.History) {
                    @:chat.client.addNewMessageToPage('@msg.FromUser', "Sergey", '@msg.Content', '@msg.Time');
                }

            }


        </script>
    }
*@
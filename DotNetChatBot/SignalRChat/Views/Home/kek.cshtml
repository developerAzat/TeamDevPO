@model SignalRChat.Models.ChatModel

<link href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
<script src="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<!------ Include the above in your HEAD tag ---------->

<!DOCTYPE html>
<html>
<head>
    <title>Chat</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.min.css">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.min.js"></script>
    @*<link rel="stylesheet" type="text/css" href="style.css">
        <script type="text/javascript" src="script.js"></script>*@
    <link href='@Url.Content("~/Content/style.css")' rel="stylesheet" type="text/css" />
    @Scripts.Render("~/bundles/modernizr")
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</head>
<!--Coded With Love By Mutiullah Samim-->
<body>
    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/bootstrap")
    @*@section scripts {*@
        <!--Script references. -->
        <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
        <!--Reference the SignalR library. -->
        <script src="~/Scripts/jquery.signalR-2.0.3.min.js"></script>
        <!--Reference the autogenerated SignalR hub script. -->
        <script src="~/signalr/hubs"></script>
        <!--SignalR script to update the chat page and send messages.-->
        <script>

            function onEnterDown(event) {
                if (event.which == 13 || event.keyCode == 13)
                    $("#sendmessage").click();
            }

            window.onload = greetGuest();

            $(function () {

                $(document).ready(function () {
                    greetGuest();
                });
                // Reference the auto-generated proxy for the hub.
                var chat = $.connection.siemplifyChatHub;

                // Create a function that the hub can call back to display messages.
                chat.client.addNewMessageToPage = function (name, to, message, time) {
                    var contactName = "Sergey";
                    if (to == "All" && contactName != 'All') {
                        //alert('not all - ' + contactName);
                        return;
                    }
                    var messagePosition = "";
                    var image = "";
                    if (name == "Guest") {
                        $('#discussion').append('<div class="d-flex justify-content-end mb-4">'+
                            '<div class= "msg_cotainer_send" >' +message+ '</div ></div >');

                       
                    }
                    else
                    {
                        $('#discussion').append('<div class="d-flex justify-content-start mb-4"> <div class="img_cont_msg"><img src = "img/sergey.jpg" class= "rounded-circle user_img_msg" ></div >' +
                            '<div class= "msg_cotainer" >' + message + '</div ></div >');
                    }

                    // Add the message to the page.
                    //$('#discussion').append('<div class="d-flex justify-content-' + messagePosition + ' mb-4 >' + image + '<div class="msg_cotainer">' + message + '</div></div>');
                };


                // callback from chat hub to add contact
                @*chat.client.addContact = function (name, department) {
                    if ($('#contacts').html().search(name) != -1) return;       // already added

                    var href = '@Url.Action("Chat", "Home")?name=' + escape($('#myname').text()) + '&contact=' + escape(name);
                    //"&department=" + htmlEncode(department);

                    $('#contacts').append('<a href=' + href + '><li><strong>' + htmlEncode(name)
                        + '</strong><span style="margin-left:50px;">' + htmlEncode(department) + '</span></li></a>');
                };

                chat.client.clearContacts = function () {
                    $('#contacts').empty();
                };*@


                // Get the user name and store it to prepend to messages.
                var myName = "Guest"; //prompt('Enter your name:', '');
                //if (myName == '')
                //    myName = 'Anonymous';

                $('#displayname').val(myName);

                var contactName = "Sergey";
                $('#activecontact').val(contactName);
                //$('#myname').text(myName);

                // Set initial focus to message input box.
                $('#message').focus();

                // Start the connection.
                $.connection.hub.start().done(function () {

                    //chat.server.connect($('#displayname').val(), $('#activecontact').val());

                    //loadHistory();

                    // send message handler
                    $('#sendmessage').click(function () {
                        // Call the Send method on the hub.
                        chat.server.send($('#displayname').val(), $('#activecontact').val(), $('#message').val());

                        // Clear text box and reset focus for next comment.
                        $('#message').val('').focus();
                    });
                });
            });

            // This optional function html-encodes messages for display in the page.
            function htmlEncode(value) {
                var encodedValue = $('<div />').text(value).html();
                return encodedValue;
            }

            function loadHistory() {
                // load history
                $('#discussion').empty();

                //alert('@Model.History.Count.ToString()' + ' messages');
                var chat = $.connection.siemplifyChatHub;

                @foreach (var msg in Model.History) {
                    @:chat.client.addNewMessageToPage('@msg.FromUser', "Sergey", '@msg.Content', '@msg.Time');
                }

               

            }

            
            function greetGuest() {
                var greetingMessage = "Добро пожаловать! Чем я могу помочь?";
                $('#discussion').append('<div class="d-flex justify-content-start mb-4"> <div class="img_cont_msg"><img src = "img/sergey.jpg" class= "rounded-circle user_img_msg" ></div >' +
                    '<div class= "msg_cotainer" >' + greetingMessage + '</div ></div >');
                //var dis = document.getElementById('discussion');
                //dis.append('<div class="d-flex justify-content-start mb-4"> <div class="img_cont_msg"><img src = "img/sergey.jpg" class= "rounded-circle user_img_msg" ></div >' +
                //    '<div class= "msg_cotainer" >' + greetingMessage + '</div ></div >');

            };


        </script>
    @*}*@
    <div class="container-fluid h-100">
        <div class="row justify-content-end h-100">
            <div class="col-md-8 col-xl-6 chat">
                <div class="card">
                    <div class="card-header msg_head">
                        <div class="d-flex bd-highlight">
                            <div class="img_cont">
                                <img src="img/sergey.jpg" class="rounded-circle user_img">
                                <span class="online_icon"></span>
                            </div>
                            <div class="user_info">
                                <span>Консультант Сергей</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body msg_card_body" id="discussion">
                        @*<div class="d-flex justify-content-start mb-4">
                            <div class="img_cont_msg">
                                <img src="sergey.jpg" class="rounded-circle user_img_msg">
                            </div>
                            <div class="msg_cotainer">
                                Добрый день! Как я могу вам помочь?
                            </div>
                        </div>*@
                    </div>
                        <div class="card-footer">
                            <div class="input-group">

                                <textarea name="" class="form-control type_msg" id="message" placeholder="Написать сообщение..." onkeypress="return onEnterDown(event)"></textarea>
                                <div class="input-group-append">
                                    <span class="input-group-text send_btn" id="sendmessage"><i class="fas fa-location-arrow"></i></span>
                                </div>
                                <input type="hidden" id="displayname" />
                                <input type="hidden" id="activecontact" />
                            </div>
                        </div>
                    </div>
                </div>
        </div>
    </div>

    @*@RenderSection("scripts", required: false)*@

</body>
</html>
